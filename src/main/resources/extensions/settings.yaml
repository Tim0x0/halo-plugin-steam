apiVersion: v1alpha1
kind: Setting
metadata:
  name: steam-settings
spec:
  forms:
    - group: basic
      label: åŸºæœ¬é…ç½®
      formSchema:
        - $el: div
          attrs:
            class: "text-sm"
            style: |
              margin-bottom: 1rem;
              margin-top: -0.5rem;
              padding: 0.75rem 1rem;
              background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
              border-radius: 0.5rem;
              border: 1px solid #bae6fd;
          children:
            - $el: div
              attrs:
                style: |
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  flex-wrap: wrap;
                  gap: 0.5rem;
              children:
                - $el: span
                  attrs:
                    style: "color: #0369a1; font-weight: 500;"
                  children: "ğŸ’¡ é…ç½®å‰å¿…è¯»"
                - $el: div
                  attrs:
                    style: "display: flex; gap: 0.5rem;"
                  children:
                    - $el: a
                      attrs:
                        href: "https://steamcommunity.com/dev/apikey"
                        target: "_blank"
                        style: |
                          color: #0369a1;
                          text-decoration: none;
                          font-size: 0.75rem;
                          border-bottom: 1px dashed #0369a1;
                      children: "è·å– API Key"
                    - $el: span
                      attrs:
                        style: "color: #bae6fd;"
                      children: "|"
                    - $el: a
                      attrs:
                        href: "https://steamid.io/"
                        target: "_blank"
                        style: |
                          color: #0369a1;
                          text-decoration: none;
                          font-size: 0.75rem;
                          border-bottom: 1px dashed #0369a1;
                      children: "æŸ¥è¯¢ Steam ID"
            - $el: div
              attrs:
                style: |
                  margin-top: 0.5rem;
                  color: #0369a1;
                  font-size: 0.75rem;
                  line-height: 1.5;
              children:
                - $el: p
                  children: "1. è¯·åŠ¡å¿…å°† Steam ä¸ªäººèµ„æ–™éšç§è®¾ç½®ä¸ºã€Œå…¬å¼€ã€ï¼Œå¦åˆ™æ— æ³•è·å–æ•°æ®"
                - $el: p
                  children: "2. å¦‚æœå›½å†…æœåŠ¡å™¨è¯·æ±‚å¤±è´¥ï¼Œè¯·åœ¨ã€Œä»£ç†é…ç½®ã€ä¸­è®¾ç½® HTTP ä»£ç†æˆ– API åä»£"
        - $formkit: verificationForm
          action: /apis/console.api.steam.timxs.com/v1alpha1/verify
          label: éªŒè¯é…ç½®
          children:
            - $formkit: password
              name: apiKey
              label: Steam API Key
              help: ä» Steam å¼€å‘è€…é¡µé¢è·å– https://steamcommunity.com/dev/apikeyã€‚ä¿®æ”¹åéœ€åˆ·æ–°ç¼“å­˜æˆ–ç­‰å¾…ç¼“å­˜è¿‡æœŸåç”Ÿæ•ˆ
              validation: required
            - $formkit: text
              name: steamId
              label: Steam ID
              help: 17ä½æ•°å­—æ ¼å¼ï¼Œå¦‚ 76561198000000000ã€‚ä¿®æ”¹åéœ€åˆ·æ–°ç¼“å­˜æˆ–ç­‰å¾…ç¼“å­˜è¿‡æœŸåç”Ÿæ•ˆ
              validation: required
        - $formkit: number
          name: cacheTtlMinutes
          label: ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
          value: 10
          min: 1
          validation: "required|min:1"
          help: æ•°æ®ç¼“å­˜æ—¶é—´ã€‚å·²ç¼“å­˜çš„æ•°æ®ä¸ä¼šç«‹å³åº”ç”¨æ–°çš„è¿‡æœŸæ—¶é—´ï¼Œéœ€ç‚¹å‡»"åˆ·æ–°ç¼“å­˜"é‡æ–°ç¼“å­˜
        - $formkit: range
          name: apiTimeoutSeconds
          id: apiTimeoutSeconds
          key: apiTimeoutSeconds
          label: API è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
          value: 8
          min: 5
          max: 60
          step: 1
          help: "$: 'å½“å‰å€¼ï¼š' + $get(apiTimeoutSeconds).value + ' ç§’ã€‚ä¸»é¢˜æ¨¡æ¿è°ƒç”¨å—æ¡†æ¶é™åˆ¶ï¼Œæœ€å¤§ 9 ç§’ï¼›REST API ä¸å—æ­¤é™åˆ¶'"
        - $el: div
          attrs:
            class: formkit-actions
            style:
              paddingTop: "16px"
              marginBottom: "16px"
          children:
            - $el: script
              attrs:
                type: text/javascript
              children: |
                async function refreshSteamCache() {
                  const btn = document.getElementById('refreshSteamCacheBtn');
                  const btnText = document.getElementById('refreshSteamCacheBtnText');
                  btn.disabled = true;
                  const oldText = btnText.textContent;
                  btnText.textContent = 'åˆ·æ–°ä¸­...';
                  try {
                    const response = await fetch('/apis/console.api.steam.timxs.com/v1alpha1/refresh', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                    });
                    const result = await response.json();
                    if (response.ok) {
                      alert(result.message || 'ç¼“å­˜åˆ·æ–°æˆåŠŸï¼');
                    } else {
                      throw new Error(result.message || 'åˆ·æ–°å¤±è´¥');
                    }
                  } catch (err) {
                    alert('åˆ·æ–°å¤±è´¥ï¼š' + err.message);
                  } finally {
                    btn.disabled = false;
                    btnText.textContent = oldText;
                  }
                }
            - $el: button
              attrs:
                type: button
                id: refreshSteamCacheBtn
                onclick: "refreshSteamCache()"
                class: "btn-sm btn-primary btn flex items-center gap-2"
              children:
                - $el: span
                  attrs:
                    id: refreshSteamCacheBtnText
                  children: åˆ·æ–°ç¼“å­˜
            - $el: div
              attrs:
                class: "formkit-help text-xs text-gray-500"
                style:
                  marginTop: "8px"
              children: "ç«‹å³åˆ·æ–° Steam æ•°æ®ç¼“å­˜"

    - group: page
      label: é¡µé¢é…ç½®
      formSchema:
        - $formkit: text
          name: pageTitle
          label: é¡µé¢æ ‡é¢˜
          value: Steam æ¸¸æˆåº“
          help: Steam é¡µé¢çš„æ ‡é¢˜
        - $formkit: number
          name: pageSize
          label: æ¯é¡µæ˜¾ç¤ºæ•°é‡
          value: 12
          min: 1
          max: 100
          help: æ¸¸æˆåº“åˆ†é¡µæ¯é¡µæ˜¾ç¤ºçš„æ¸¸æˆæ•°é‡
        - $formkit: number
          name: gamesLimit
          label: æ¸¸æˆåº“æ€»æ•°é‡é™åˆ¶
          value: 50
          min: 0
          max: 500
          help: æ¸¸æˆåº“æœ€å¤šæ˜¾ç¤ºçš„æ¸¸æˆæ•°é‡ï¼ˆæŒ‰æ¸¸ç©æ—¶é•¿æ’åºï¼‰ï¼Œè®¾ä¸º 0 åˆ™ä¸é™åˆ¶
        - $formkit: number
          name: recentGamesLimit
          label: æœ€è¿‘æ¸¸ç©æ˜¾ç¤ºæ•°é‡
          value: 5
          min: 1
          max: 20
          help: æœ€è¿‘æ¸¸ç©é¡µé¢æ˜¾ç¤ºçš„æ¸¸æˆæ•°é‡
        - $formkit: checkbox
          name: showRecentAchievements
          label: æ˜¾ç¤ºæœ€è¿‘æ¸¸ç©æˆå°±è¿›åº¦
          value: false
          help: å¼€å¯åä¼šåœ¨æœ€è¿‘æ¸¸ç©çš„æ¸¸æˆå¡ç‰‡ä¸Šæ˜¾ç¤ºæˆå°±å®Œæˆè¿›åº¦ï¼Œä¼šå¢åŠ é¡µé¢åŠ è½½æ—¶é—´
        - $formkit: checkbox
          name: enableGameLink
          label: ç‚¹å‡»æ¸¸æˆå¡ç‰‡è·³è½¬ Steam å•†åŸ
          value: false
          help: å…³é—­åç‚¹å‡»æ¸¸æˆå¡ç‰‡ä¸ä¼šè·³è½¬åˆ° Steam å•†åŸé¡µé¢
        - $formkit: checkbox
          name: includeFreeGames
          label: åŒ…å«å…è´¹æ¸¸æˆ
          value: true
          help: å¼€å¯åæ¸¸æˆåº“ä¼šåŒ…å«ç©è¿‡çš„å…è´¹æ¸¸æˆï¼ˆå¦‚ CS2ã€Dota 2 ç­‰ï¼‰ã€‚ä¿®æ”¹åéœ€åˆ·æ–°ç¼“å­˜æˆ–ç­‰å¾…ç¼“å­˜è¿‡æœŸåç”Ÿæ•ˆ
        - $formkit: array
          name: hiddenGames
          label: éšè—çš„æ¸¸æˆ
          addLabel: æ·»åŠ æ¸¸æˆ
          help: "å¦‚ä½•è·å–æ¸¸æˆ IDï¼Ÿ1. æ‰“å¼€æ¸¸æˆçš„ Steam å•†åº—é¡µé¢ï¼ˆå¦‚ https://store.steampowered.com/app/730/ï¼‰2. é“¾æ¥ä¸­çš„æ•°å­—ï¼ˆ730ï¼‰å°±æ˜¯æ¸¸æˆ IDã€‚3. å¯ç›´æ¥ç²˜è´´é“¾æ¥æˆ–åªè¾“å…¥æ•°å­—ã€‚"
          children:
            - $formkit: text
              name: game
              label: æ¸¸æˆ ID æˆ–é“¾æ¥
              placeholder: "730 æˆ– https://store.steampowered.com/app/730/"
              validation: required
          value: []
 
    - group: badge
      label: å¾½ç« é…ç½®
      formSchema:
        - $formkit: array
          name: badgeMappings
          label: ç³»ç»Ÿå¾½ç« å›¾ç‰‡æ˜ å°„
          addLabel: æ·»åŠ æ˜ å°„
          help: "é…ç½® Steam ç³»ç»Ÿå¾½ç« çš„å›¾ç‰‡ URLã€‚badgeId å¯åœ¨ Steam å¾½ç« é¡µé¢ URL ä¸­æŸ¥çœ‹ï¼ˆå¦‚ /badges/1 ä¸­çš„ 1ï¼‰"
          children:
            - $formkit: number
              name: badgeId
              label: Badge ID
              validation: required
              help: "Steam å¾½ç«  ID"
            - $formkit: text
              name: name
              label: å¾½ç« åç§°
              help: "ä¾¿äºè¯†åˆ«ï¼ˆå¯é€‰ï¼‰"
            - $formkit: text
              name: imageUrl
              label: å›¾ç‰‡ URL
              validation: required
              help: "å¾½ç« å›¾ç‰‡å®Œæ•´åœ°å€ï¼Œå¯ä» Steam é¡µé¢å³é”®å¤åˆ¶"
          value: []

    - group: stats
      label: ç»Ÿè®¡
      formSchema:
        - $formkit: switch
          name: enableTracking
          id: enableTracking
          key: enableTracking
          label: å¯ç”¨æ¸¸æˆæ—¶é•¿è¿½è¸ª
          value: false
          help: å¼€å¯åå°†æ¯å°æ—¶è¿½è¸ªæ¸¸æˆæ—¶é•¿å˜åŒ–ï¼Œç”¨äºç”Ÿæˆçƒ­åŠ›å›¾ã€‚é¦–æ¬¡å¯ç”¨åéœ€ç­‰å¾…è‡³å°‘ 1 å°æ—¶æ‰ä¼šæœ‰æ•°æ®
        - $formkit: number
          name: retentionDays
          label: æ•°æ®ä¿ç•™å¤©æ•°
          value: 365
          min: 30
          max: 3650
          help: æ¯æ—¥æ¸¸æˆæ—¶é•¿è®°å½•çš„ä¿ç•™å¤©æ•°ï¼Œè¶…è¿‡æ­¤å¤©æ•°çš„æ•°æ®å°†è¢«è‡ªåŠ¨æ¸…ç†ï¼ˆæ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œï¼‰
          if: "$get(enableTracking).value === true"
        - $el: div
          attrs:
            class: "formkit-help text-sm text-gray-600 bg-blue-50 p-3 rounded"
            style:
              marginTop: "16px"
          if: "$get(enableTracking).value === true"
          children:
            - $el: p
              attrs:
                style:
                  marginBottom: "8px"
              children: "âš ï¸ é‡è¦è¯´æ˜ï¼š"
            - $el: ul
              attrs:
                style:
                  listStyleType: "disc"
                  paddingLeft: "20px"
              children:
                - $el: li
                  children: "çƒ­åŠ›å›¾åŠŸèƒ½é€šè¿‡å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å°æ—¶ç¬¬ 59 åˆ†é’Ÿï¼‰è¿½è¸ªæ¸¸æˆæ—¶é•¿å˜åŒ–"
                - $el: li
                  children: "Steam API ä¸æä¾›å†å²æ•°æ®ï¼Œåªèƒ½ä»å¯ç”¨åŠŸèƒ½åå¼€å§‹è®°å½•"
                - $el: li
                  children: "é¦–æ¬¡å‘ç°çš„æ¸¸æˆä¸ä¼šè®°å½•å½“å‰ç´¯è®¡æ—¶é•¿ï¼Œä»ä¸‹æ¬¡è¿½è¸ªå¼€å§‹è®¡ç®—"
                - $el: li
                  children: "æœåŠ¡å™¨åœæœºæœŸé—´çš„æ¸¸æˆæ—¶é•¿æ— æ³•å‡†ç¡®è¿½è¸ª"
                - $el: li
                  children: "æ•°æ®å­˜å‚¨åœ¨ Halo æ•°æ®åº“ä¸­ï¼Œç¦ç”¨åŠŸèƒ½ä¸ä¼šåˆ é™¤å·²æœ‰æ•°æ®"
        - $el: div
          attrs:
            class: formkit-actions
            style:
              paddingTop: "16px"
              marginBottom: "16px"
              borderBottom: "1px solid #e5e7eb"
              paddingBottom: "16px"
          if: "$get(enableTracking).value === true"
          children:
            - $el: script
              attrs:
                type: text/javascript
              children: |
                async function manualTrackPlaytime() {
                  const btn = document.getElementById('manualTrackBtn');
                  const btnText = document.getElementById('manualTrackBtnText');
                  btn.disabled = true;
                  const oldText = btnText.textContent;
                  btnText.textContent = 'è¿½è¸ªä¸­...';
                  try {
                    const response = await fetch('/apis/console.api.steam.timxs.com/v1alpha1/heatmap/track', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                      alert(result.message || 'è¿½è¸ªå®Œæˆï¼');
                    } else {
                      throw new Error(result.message || 'è¿½è¸ªå¤±è´¥');
                    }
                  } catch (err) {
                    alert('è¿½è¸ªå¤±è´¥ï¼š' + err.message);
                  } finally {
                    btn.disabled = false;
                    btnText.textContent = oldText;
                  }
                }
            - $el: button
              attrs:
                type: button
                id: manualTrackBtn
                onclick: "manualTrackPlaytime()"
                class: "btn-sm btn-secondary btn flex items-center gap-2"
              children:
                - $el: span
                  attrs:
                    id: manualTrackBtnText
                  children: æ‰‹åŠ¨è¿½è¸ªæ—¶é•¿
            - $el: div
              attrs:
                class: "formkit-help text-xs text-gray-500"
                style:
                  marginTop: "8px"
              children: "ç«‹å³æ‰§è¡Œä¸€æ¬¡æ¸¸æˆæ—¶é•¿è¿½è¸ªï¼ˆç”¨äºæµ‹è¯•ï¼‰"
        
        # çƒ­åŠ›å›¾æ˜¾ç¤ºé…ç½®ç»„
        - $formkit: group
          name: heatmapDisplay
          label: çƒ­åŠ›å›¾æ˜¾ç¤º
          if: "$get(enableTracking).value === true"
          children:
            - $formkit: switch
              name: showHeatmap
              id: showHeatmap
              key: showHeatmap
              label: åœ¨é¡µé¢æ˜¾ç¤ºçƒ­åŠ›å›¾
              value: false
              help: å¼€å¯åä¼šåœ¨ç»Ÿè®¡æ ä¸‹æ–¹æ˜¾ç¤ºæ¸¸æˆæ—¶é•¿çƒ­åŠ›å›¾
            - $formkit: number
              name: heatmapDays
              label: æ˜¾ç¤ºå¤©æ•°
              value: 365
              min: 30
              max: 730
              help: çƒ­åŠ›å›¾æ˜¾ç¤ºæœ€è¿‘å¤šå°‘å¤©çš„æ•°æ®ï¼ˆé»˜è®¤ 365 å¤©ï¼Œå³ä¸€å¹´ï¼‰
              if: "$get(showHeatmap).value === true"
            - $formkit: select
              name: heatmapColorTheme
              label: é¢œè‰²ä¸»é¢˜
              value: steam
              options:
                - label: Steam è“è‰²
                  value: steam
                - label: GitHub ç»¿è‰²
                  value: github
                - label: ç«ç„°æ©™è‰²
                  value: fire
                - label: ç´«è‰²æ¢¦å¹»
                  value: purple
              help: é€‰æ‹©çƒ­åŠ›å›¾çš„é¢œè‰²é£æ ¼
              if: "$get(showHeatmap).value === true"
            - $formkit: checkbox
              name: heatmapShowLegend
              label: æ˜¾ç¤ºå›¾ä¾‹
              value: false
              help: æ˜¯å¦æ˜¾ç¤ºçƒ­åŠ›å›¾çš„é¢œè‰²å›¾ä¾‹
              if: "$get(showHeatmap).value === true"
    - group: proxy
      label: ä»£ç†é…ç½®
      formSchema:
        - $formkit: group
          name: imageProxy
          label: å›¾ç‰‡åŠ é€Ÿ
          children:
            - $formkit: text
              name: headerImageTemplate
              label: æ¸¸æˆå°é¢å›¾åŠ é€Ÿåœ°å€
              value: https://cdn.cloudflare.steamstatic.com/steam/apps/{appid}/header.jpg
              help: "é»˜è®¤å€¼ï¼šhttps://cdn.cloudflare.steamstatic.com/steam/apps/{appid}/header.jpgã€‚æ”¯æŒå ä½ç¬¦: {appid}"
            - $formkit: text
              name: iconImageTemplate
              label: æ¸¸æˆå›¾æ ‡åŠ é€Ÿåœ°å€
              value: https://media.steampowered.com/steamcommunity/public/images/apps/{appid}/{hash}.jpg
              help: "é»˜è®¤å€¼ï¼šhttps://media.steampowered.com/steamcommunity/public/images/apps/{appid}/{hash}.jpgã€‚æ”¯æŒå ä½ç¬¦: {appid}, {hash}"
        - $formkit: group
          name: apiProxy
          label: Steam API ä»£ç†
          children:
            - $formkit: switch
              name: enabled
              id: apiProxyEnabled
              key: apiProxyEnabled
              label: å¯ç”¨ Steam API ä»£ç†
              value: false
              help: ä¿®æ”¹åéœ€åˆ·æ–°ç¼“å­˜æˆ–ç­‰å¾…ç¼“å­˜è¿‡æœŸåç”Ÿæ•ˆ
            - $formkit: radio
              name: proxyType
              id: apiProxyType
              key: apiProxyType
              label: ä»£ç†æ–¹å¼
              value: http
              options:
                - label: HTTP ä»£ç†
                  value: http
                - label: è‡ªå®šä¹‰ API åœ°å€
                  value: custom
              if: "$get(apiProxyEnabled).value === true"
            - $formkit: text
              name: httpHost
              id: httpHost
              key: httpHost
              label: ä»£ç†ä¸»æœº
              placeholder: "127.0.0.1"
              validation: required
              help: ä¿®æ”¹åéœ€åˆ·æ–°ç¼“å­˜æˆ–ç­‰å¾…ç¼“å­˜è¿‡æœŸåç”Ÿæ•ˆ
              if: "$get(apiProxyEnabled).value === true && $get(apiProxyType).value === 'http'"
            - $formkit: number
              name: httpPort
              id: httpPort
              key: httpPort
              label: ä»£ç†ç«¯å£
              placeholder: "7890"
              min: 1
              max: 65535
              validation: required
              help: ä¿®æ”¹åéœ€åˆ·æ–°ç¼“å­˜æˆ–ç­‰å¾…ç¼“å­˜è¿‡æœŸåç”Ÿæ•ˆ
              if: "$get(apiProxyEnabled).value === true && $get(apiProxyType).value === 'http'"
            - $formkit: text
              name: customApiUrl
              id: customApiUrl
              key: customApiUrl
              label: è‡ªå®šä¹‰ API åœ°å€
              placeholder: "https://your-steam-api-proxy.com"
              help: "æ›¿æ¢ api.steampowered.com çš„åœ°å€ã€‚ä¿®æ”¹åéœ€åˆ·æ–°ç¼“å­˜æˆ–ç­‰å¾…ç¼“å­˜è¿‡æœŸåç”Ÿæ•ˆ"
              validation: required
              if: "$get(apiProxyEnabled).value === true && $get(apiProxyType).value === 'custom'"

